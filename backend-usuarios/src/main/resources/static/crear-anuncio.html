<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crear Publicación</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-4">
        <div class="row mb-4">
            <div class="col">
                <h2>Crear Nueva Publicación</h2>
            </div>
            <div class="col text-end">
                <a href="listar-anuncios.html" class="btn btn-secondary">Volver a la lista</a>
            </div>
        </div>

        <div class="row">
            <div class="col-md-8 offset-md-2">
                <div class="card">
                    <div class="card-body">
                        <!-- Publication Type Selector -->
                        <div class="mb-3">
                            <label for="publicationType" class="form-label">Tipo de Publicación</label>
                            <select class="form-select" id="publicationType" onchange="cambiarTipoPublicacion()">
                                <option value="anuncio">Anuncio</option>
                                <option value="evento">Evento</option>
                                <option value="webinar">Webinar</option>
                            </select>
                        </div>

                        <!-- Common Form Fields -->
                        <form id="publicationForm" onsubmit="crearPublicacion(event)">
                            <div class="mb-3">
                                <label for="titulo" class="form-label">Título</label>
                                <input type="text" class="form-control" id="titulo" maxlength="200" required>
                            </div>
                            <div class="mb-3">
                                <label for="contenido" class="form-label">Contenido</label>
                                <textarea class="form-control" id="contenido" rows="5" required></textarea>
                            </div>

                            <!-- Anuncio Fields -->
                            <div id="anuncioFields">
                                <div class="mb-3">
                                    <label for="tipo" class="form-label">Tipo de Anuncio</label>
                                    <select class="form-select" id="tipo" onchange="mostrarCamposAdicionales()" required>
                                        <option value="GEN">General</option>
                                        <option value="CAR">Por Carrera</option>
                                        <option value="DEP">Por Departamento</option>
                                    </select>
                                </div>
                                <div class="mb-3" id="carreraDiv" style="display: none;">
                                    <label for="carrera" class="form-label">Carrera</label>
                                    <select class="form-select" id="carrera">
                                        <!-- Se llenará dinámicamente -->
                                    </select>
                                </div>
                                <div class="mb-3" id="departamentoDiv" style="display: none;">
                                    <label for="departamento" class="form-label">Departamento</label>
                                    <select class="form-select" id="departamento">
                                        <!-- Se llenará dinámicamente -->
                                    </select>
                                </div>
                            </div>

                            <!-- Evento Fields -->
                            <div id="eventoFields" style="display: none;">
                                <div class="mb-3">
                                    <label for="fecha" class="form-label">Fecha del Evento</label>
                                    <input type="datetime-local" class="form-control" id="fecha">
                                </div>
                                <div class="mb-3">
                                    <label for="lugar" class="form-label">Lugar</label>
                                    <input type="text" class="form-control" id="lugar">
                                </div>
                                <div class="mb-3">
                                    <label for="capacidad" class="form-label">Capacidad</label>
                                    <input type="number" class="form-control" id="capacidad" min="1">
                                </div>
                            </div>

                            <!-- Webinar Fields -->
                            <div id="webinarFields" style="display: none;">
                                <div class="mb-3">
                                    <label for="fechaWebinar" class="form-label">Fecha del Webinar</label>
                                    <input type="datetime-local" class="form-control" id="fechaWebinar">
                                </div>
                                <div class="mb-3">
                                    <label for="plataforma" class="form-label">Plataforma</label>
                                    <input type="text" class="form-control" id="plataforma">
                                </div>
                                <div class="mb-3">
                                    <label for="enlace" class="form-label">Enlace</label>
                                    <input type="url" class="form-control" id="enlace">
                                </div>
                                <div class="mb-3">
                                    <label for="ponente" class="form-label">Ponente</label>
                                    <input type="text" class="form-control" id="ponente">
                                </div>
                            </div>

                            <div class="text-end">
                                <button type="submit" class="btn btn-primary">Guardar Publicación</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Verificar autenticación al cargar la página
        document.addEventListener('DOMContentLoaded', function() {
            const token = localStorage.getItem('token');
            if (!token) {
                alert('Debe iniciar sesión para crear publicaciones');
                window.location.href = 'login.html';
                return;
            }
            cargarCarreras();
            cargarDepartamentos();
        });

        function cambiarTipoPublicacion() {
            const type = document.getElementById('publicationType').value;
            document.getElementById('anuncioFields').style.display = 'none';
            document.getElementById('eventoFields').style.display = 'none';
            document.getElementById('webinarFields').style.display = 'none';
            
            // Show the fields for the selected type
            document.getElementById(type + 'Fields').style.display = 'block';

            // Update required attributes
            setRequiredFields(type);
        }

        function setRequiredFields(type) {
            // Reset all required fields
            const allFields = document.querySelectorAll('input, select, textarea');
            allFields.forEach(field => field.required = false);

            // Set common required fields
            document.getElementById('titulo').required = true;
            document.getElementById('contenido').required = true;

            // Set type-specific required fields
            switch(type) {
                case 'anuncio':
                    document.getElementById('tipo').required = true;
                    const tipoAnuncio = document.getElementById('tipo').value;
                    if (tipoAnuncio === 'CAR') document.getElementById('carrera').required = true;
                    if (tipoAnuncio === 'DEP') document.getElementById('departamento').required = true;
                    break;
                case 'evento':
                    document.getElementById('fecha').required = true;
                    document.getElementById('lugar').required = true;
                    document.getElementById('capacidad').required = true;
                    break;
                case 'webinar':
                    document.getElementById('fechaWebinar').required = true;
                    document.getElementById('plataforma').required = true;
                    document.getElementById('enlace').required = true;
                    document.getElementById('ponente').required = true;
                    break;
            }
        }

        function mostrarCamposAdicionales() {
            const tipo = document.getElementById('tipo').value;
            document.getElementById('carreraDiv').style.display = tipo === 'CAR' ? 'block' : 'none';
            document.getElementById('departamentoDiv').style.display = tipo === 'DEP' ? 'block' : 'none';
            setRequiredFields('anuncio');
        }

        function cargarCarreras() {
            const token = localStorage.getItem('token');
            fetch('/api/carreras', {
                headers: {
                    'Authorization': 'Bearer ' + token
                }
            })
            .then(response => response.json())
            .then(carreras => {
                const select = document.getElementById('carrera');
                carreras.forEach(carrera => {
                    const option = document.createElement('option');
                    option.value = carrera.id;
                    option.textContent = carrera.nombre;
                    select.appendChild(option);
                });
            })
            .catch(error => console.error('Error cargando carreras:', error));
        }

        function cargarDepartamentos() {
            const token = localStorage.getItem('token');
            fetch('/api/departamentos', {
                headers: {
                    'Authorization': 'Bearer ' + token
                }
            })
            .then(response => response.json())
            .then(departamentos => {
                const select = document.getElementById('departamento');
                departamentos.forEach(depto => {
                    const option = document.createElement('option');
                    option.value = depto.id;
                    option.textContent = depto.nombre;
                    select.appendChild(option);
                });
            })
            .catch(error => console.error('Error cargando departamentos:', error));
        }

        function crearPublicacion(event) {
            event.preventDefault();
            
            const token = localStorage.getItem('token');
            if (!token) {
                alert('No está autenticado. Por favor, inicie sesión.');
                window.location.href = 'login.html';
                return;
            }

            const type = document.getElementById('publicationType').value;
            let endpoint = '';
            let data = {};

            // Campos comunes
            data.titulo = document.getElementById('titulo').value;

            switch(type) {
                case 'anuncio':
                    endpoint = '/api/anuncios';
                    data.contenido = document.getElementById('contenido').value;
                    data.tipo = document.getElementById('tipo').value;
                    if (data.tipo === 'CAR') {
                        data.carrera = { id: document.getElementById('carrera').value };
                    } else if (data.tipo === 'DEP') {
                        data.departamento = { id: document.getElementById('departamento').value };
                    }
                    break;

                case 'evento':
                    endpoint = '/api/eventos';
                    data = {
                        titulo: document.getElementById('titulo').value,
                        descripcion: document.getElementById('contenido').value, // Usando 'descripcion' en lugar de 'contenido'
                        fechaInicio: document.getElementById('fecha').value, // Cambiado de 'fecha' a 'fechaInicio'
                        ubicacion: document.getElementById('lugar').value, // Cambiado de 'lugar' a 'ubicacion'
                        capacidad: parseInt(document.getElementById('capacidad').value)
                    };
                    // Establecer fechaFin como fechaInicio + 2 horas por defecto
                    const fechaInicio = new Date(data.fechaInicio);
                    const fechaFin = new Date(fechaInicio.getTime() + (2 * 60 * 60 * 1000));
                    data.fechaFin = fechaFin.toISOString().slice(0, 16);
                    break;

                case 'webinar':
                    endpoint = '/api/webinars';
                    data = {
                        titulo: document.getElementById('titulo').value,
                        descripcion: document.getElementById('contenido').value, // Usando 'descripcion' en lugar de 'contenido'
                        fecha: document.getElementById('fechaWebinar').value,
                        plataforma: document.getElementById('plataforma').value,
                        enlace: document.getElementById('enlace').value,
                        expositor: document.getElementById('ponente').value // Cambiado de 'ponente' a 'expositor'
                    };
                    break;
            }

            console.log('Enviando datos:', data);

            fetch(endpoint, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + token
                },
                body: JSON.stringify(data)
            })
            .then(response => {
                if (!response.ok) {
                    return response.text().then(text => {
                        console.error('Error response:', text);
                        if (response.status === 401) {
                            throw new Error('No autorizado. Por favor, inicie sesión nuevamente.');
                        }
                        throw new Error(text || 'Error al crear la publicación');
                    });
                }
                return response.json();
            })
            .then(data => {
                console.log('Respuesta exitosa:', data);
                alert('Publicación creada exitosamente');
                window.location.href = 'listar-anuncios.html';
            })
            .catch(error => {
                console.error('Error detallado:', error);
                if (error.message.includes('No autorizado')) {
                    localStorage.removeItem('token');
                    window.location.href = 'login.html';
                } else {
                    alert(error.message || 'Error al crear la publicación');
                }
            });
        }

        // Initialize the form
        cambiarTipoPublicacion();
    </script>
</body>
</html>
